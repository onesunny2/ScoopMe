//
//  CommunityView.swift
//  ScoopMe
//
//  Created by Lee Wonsun on 5/17/25.
//

import SwiftUI
import SCMCommunity
import SCMLogger

struct CommunityView: View {
    
    private let repository: CommunityPostDisplayable
    private let chatListRepository: ChatListDisplayable
    
    @State private var debounceTask: Task<Void, Never>?  // Ïû¶ÏùÄ Ìò∏Ï∂úÎ∞©ÏßÄ
    
    // pagination
    @State private var isLoading: Bool = false
    @State private var cursorID: String? = nil
    
    @State private var searchKeyword: String = ""
    @State private var volume: CGFloat = 0.3
    
    @State private var selectedFilter: TimelineFilter = .ÏµúÏã†Ïàú
    @State private var posts: [CommunityPostEntity] = []
    
    // Ï±ÑÌåÖÏ∞Ω Ìò∏Ï∂ú Ìä∏Î¶¨Í±∞
    @State private var isMessageOpened: Bool = false
    @State private var roomID: String = ""
    @State private var opponentName: String = ""
    @State private var opponentID: String = ""
    
    // Í≤åÏãúÍ∏Ä ÏàòÏ†ï, ÏÇ≠Ï†ú
    @State private var isPostDeleted: Bool = false
    @State private var deletePostID: String = ""
    @State private var isPostEdited: Bool = false
    @State private var editPost: CommunityPostEntity? = nil
    @State private var isEditCompleted: Bool = false
    @State private var isEditFailed: Bool = false
    
    // ÎåìÍ∏Ä
    @State private var tappedComments: Bool = false
    @State private var postComments: [CommentResponseDTO] = []
    
    init(repository: CommunityPostDisplayable, chatListRepository: ChatListDisplayable) {
        self.repository = repository
        self.chatListRepository = chatListRepository
    }
    
    var body: some View {
        NavigationStack {
            VStack(spacing: 20) {
                SearchTextFieldCell(
                    placeholder: StringLiterals.placeholder.text,
                    keyword: $searchKeyword
                )
                
                distanceSliderCell
                timelineTitleAndFilter
                
                if !posts.isEmpty {
                    postContentsView
                } else {
                    noResultsView
                }
            }
            .defaultHorizontalPadding()
            .navigationTitle(StringLiterals.navigationTitle.text)
            .navigationBarTitleDisplayMode(.inline)
            .task {
                await getCommunityPost()
            }
            .onChange(of: volume) { _ in
                applyDebounceForRequestPost()
            }
            .onChange(of: selectedFilter) { _ in
                cursorID = nil
                Task { await getCommunityPost() }
            }
            .fullScreenCover(isPresented: $isMessageOpened) {
                NavigationStack {
                    ChatRoomView(
                        chatRoomRepository: DIContainer.shared.chatRoomRepository,
                        socketChatManager: DIContainer.shared.socketChatManager,
                        notificationBadgeManager: DIContainer.shared.notificationBadgeManager,
                        roomID: $roomID,
                        opponentName: $opponentName
                    )
                }
            }
            .sheet(isPresented: $isPostEdited) {
                EditPostContentView(
                    post: $editPost,
                    isEditCompleted: $isEditCompleted,
                    iseditFailed: $isEditFailed
                ) { newPost in
                    Task {
                        await editPost(postID: editPost?.postID ?? "", content: newPost)
                    }
                } tappedResave: { newPost in
                    Task {
                        await editPost(postID: editPost?.postID ?? "", content: newPost)
                    }
                }
                .presentationDetents([.medium])
                .presentationDragIndicator(.visible)
            }
            .sheet(isPresented: $tappedComments) {
                PostCommentView(
                    imageHelper: DIContainer.shared.imageHelper,
                    comments: postComments
                )
                .presentationDetents([.medium])
                .presentationDragIndicator(.visible)
            }
            .showAlert(
                isPresented: $isPostDeleted,
                title: "ÏÇ≠Ï†ú",
                message: "Ìï¥Îãπ Ìè¨Ïä§Ìä∏Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?",
                buttonTitle: nil) {
                    Task {
                        await deletePost(postID: deletePostID)
                    }
                }
        }
    }
}

// MARK: UI
extension CommunityView {
    
    private var distanceSliderCell: some View {
        HStack(alignment: .center, spacing: 8) {
            Text(StringLiterals.distance.text + ": " + String(format: "%.2f", volume) + "km")
                .basicText(.PTBody4, .scmBlackSprout)
                .padding(.horizontal, 8)
                .padding(.vertical, 4)
                .background(
                    RoundedRectangle(cornerRadius: 4).fill(.scmGray15)
                        .overlay {
                            RoundedRectangle(cornerRadius: 4)
                                .stroke(Color.scmBlackSprout, lineWidth: 0.5)
                        }
                )
                .animation(nil, value: volume)
            
            ExpendableSliderCell(value: $volume, in: 0...1) {
                HStack {
                    Image(.distance)
                        .basicImage(width: 24, color: .scmBrightSprout)
                    
                    Spacer()
                }
                .defaultHorizontalPadding()
            }
        }
    }
    
    private var timelineTitleAndFilter: some View {
        HStack(alignment: .center) {
            Text(StringLiterals.timelineTitle.text)
                .basicText(.PTTitle4, .scmGray90)
            
            Spacer()
            
            HStack(alignment: .center, spacing: 4) {
                Text(selectedFilter.text)
                    .basicText(.PTCaption1, .scmBlackSprout)
                Image(.list)
                    .basicImage(width: 16, color: .scmBlackSprout)
            }
            .asButton {
                switch selectedFilter {
                case .ÏµúÏã†Ïàú: selectedFilter = .Ï¢ãÏïÑÏöîÏàú
                case .Ï¢ãÏïÑÏöîÏàú: selectedFilter = .ÏµúÏã†Ïàú
                @unknown default:
                    selectedFilter = .ÏµúÏã†Ïàú
                }
            }
        }
        .padding(.bottom, -14)
    }
    
    @ViewBuilder
    private var postContentsView: some View {
        ScrollView(.vertical, showsIndicators: false) {
            LazyVStack {
                LazyVStack(alignment: .leading, spacing: 0) {
                    ForEach(posts, id: \.postID) { post in
                        Rectangle()
                            .fill(.scmBrightSprout)
                            .frame(height: 1)
                        
                        CommunityPostCell(
                            post: post,
                            tappedMessage: { creator in
                                opponentID = creator.id
                                opponentName = creator.nickname
                                Log.debug("üîó ÏÉÅÎåÄÎ∞©Ïù¥Î¶Ñ: \(opponentName)", "ÏÉÅÎåÄÎ∞©ID: \(opponentID)")
                                
                                Task {
                                    let success = await fetchRoomID()
                                    
                                    if success {
                                        isMessageOpened = true
                                    }
                                }
                            },
                            tappedDelete: { postID in
                                isPostDeleted = true
                                deletePostID = postID
                            },
                            tappedEdit: { post in
                                isPostEdited = true
                                editPost = post
                            },
                            tappedComment: { post in
                                tappedComments = true
                                postComments = post.comments
                            })
                        .padding(.vertical, 12)
                        .onAppear {
                            if (post.postID == posts.last?.postID) && cursorID != "0" {
                                Task { await getCommunityPostForPagination() }
                            }
                        }
                    }
                }
                .padding(.top, 6)
                
                if isLoading {
                    ProgressView()
                        .padding(4)
                }
            }
        }
    }
    
    private var noResultsView: some View {
        VStack {
            Spacer()
            Text(StringLiterals.noResults.text)
                .basicText(.PTBody1, .scmGray90)
            Spacer()
        }
    }
}

// MARK: Action
extension CommunityView {
    
    // ÏúÑÏπòÍ∏∞Î∞ò Ìè¨Ïä§Ìä∏ Ìò∏Ï∂ú
    private func getCommunityPost() async {
        do {
            isLoading = true
            
            let posts = try await repository.getCommunityPost(
                max: Int(volume * 1000),
                orderBy: selectedFilter,
                next: cursorID
            )
            cursorID = posts.next
            self.posts = posts.data
            
            isLoading = false
        } catch {
            Log.error("Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®: \(error)")
        }
    }
    
    // ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò Ï†ÑÏö©
    private func getCommunityPostForPagination() async {
        do {
            isLoading = true
            
            let posts = try await repository.getCommunityPost(
                max: Int(volume * 1000),
                orderBy: selectedFilter,
                next: cursorID
            )
            self.posts.append(contentsOf: posts.data)
            cursorID = posts.next
            
            isLoading = false
        } catch {
            Log.error("Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®: \(error)")
        }
    }
    
    // Ìè¨Ïä§Ìä∏ Ìò∏Ï∂ú debounce
    private func applyDebounceForRequestPost() {
        debounceTask?.cancel()
        
        debounceTask = Task {
            try? await Task.sleep(for: .seconds(0.5))
            
            if !Task.isCancelled {
                await getCommunityPost()
            }
        }
    }
    
    // Ï±ÑÌåÖÏ∞Ω ÏßÑÏûÖ Ïãú roomID Ï≤¥ÌÅ¨
    private func fetchRoomID() async -> Bool {
        do {
            let fetchedRoomID = try await chatListRepository.getChatroomID(opponent: opponentID)
            
            await MainActor.run {
                self.roomID = fetchedRoomID
            }
            Log.debug("‚úÖ Ï°∞ÌöåÎêú roomID: \(self.roomID)")
            
            return !fetchedRoomID.isEmpty
        } catch {
            Log.error("‚ùå roomID Ï°∞ÌöåÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: \(error)")
            return false
        }
    }
    
    // Ìè¨Ïä§Ìä∏ ÏÇ≠Ï†ú
    private func deletePost(postID: String) async {
        do {
            try await repository.deleteCommunityPost(postID: postID)
            
            guard let index = posts.firstIndex(where: {
                $0.postID == postID
            }) else { return }
            
            posts.remove(at: index)  // Ìï¥Îãπ Ìè¨Ïä§Ìä∏ ÏÇ≠Ï†ú!
            
        } catch {
            Log.error("‚ùå Ìè¨Ïä§Ìä∏ ÏÇ≠Ï†ú Ïã§Ìå®: \(error)")
            isEditFailed = true
        }
    }
    
    // Ìè¨Ïä§Ìä∏ ÏàòÏ†ï
    private func editPost(
        postID: String,
        content: EditContent
    ) async {
        do {
            try await repository.editContents(postID: postID, content: content)
            
            // Ïó¨Í∏∞ÏÑú ÏàòÏ†ïÌïú Í≤åÏãúÍ∏Ä Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏ Ìï¥Ï§òÏïº Ìï®!
            guard let index = posts.firstIndex(where: { $0.postID == postID }) else { return }
            posts[index].postTitle = content.title
            posts[index].postContent = content.content
            
            isEditCompleted = true
        } catch {
            Log.error("‚ùå Ìè¨Ïä§Ìä∏ ÏàòÏ†ï Ïã§Ìå®: \(error)")
            isEditFailed = true
        }
    }
}

// MARK: StringLiterals
private enum StringLiterals: String {
    case navigationTitle = "Ïä§Ïø±ÎØ∏ ÏÜåÏãùÌÜµ"
    case placeholder = "Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî."
    case timelineTitle = "Ìè¨Ïä§Ìä∏"
    case distance = "Î≤îÏúÑ"
    case noResults = "Ï°∞Í±¥Ïóê ÎßûÎäî Ìè¨Ïä§Ìä∏Í∞Ä ÏóÜÏäµÎãàÎã§"
    
    var text: String {
        return self.rawValue
    }
}

#Preview {
    CommunityView(repository: DIContainer.shared.communityPostRepository, chatListRepository: DIContainer.shared.chatListRepository)
}

